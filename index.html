<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            display: flex;
            gap: 20px;
        }
        .threads-list {
            width: 250px;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f8f9fa;
            height: 400px;
            overflow-y: auto;
        }
        .chat-box {
            flex-grow: 1;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f8f9fa;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Chat</h2>
        <button class="btn btn-success mb-3" onclick="createThread()">Create New Thread</button>
        <div class="chat-container">
            <div class="threads-list" id="threadsList">
                <h5>Threads</h5>
                <ul class="list-group" id="threadItems">
                    <!-- Threads will be loaded here -->
                </ul>
            </div>
            <div class="chat-box mb-3" id="chatBox">
                <!-- Messages will appear here -->
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" class="form-control" placeholder="Type a message...">
            <input type="file" id="fileInput" class="form-control">
            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJzOTAwMzI1OTk4OEBnbWFpbC5jb20iLCJ1c2VyX2lkIjoyLCJleHAiOjE3NDAzNjUyNzB9.hEWiaZqp-JYZnbIZIRi1SDYdGOJmHNNumoReYFsq-o0";
        let threadId = "";

        async function createThread() {
            const response = await fetch("http://127.0.0.1:8000/create_thread", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                alert("Error creating thread");
                return;
            }
            
            const result = await response.json();
            alert("Thread created successfully: " + result.thread_id);
            loadThreads();
        }

        async function loadThreads() {
            const threadsList = document.getElementById('threadItems');
            threadsList.innerHTML = "";

            const response = await fetch("http://127.0.0.1:8000/chat/threads", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                alert("Error loading threads");
                return;
            }
            
            const result = await response.json();
            result.threads.forEach(thread => {
                const threadItem = document.createElement("li");
                threadItem.classList.add("list-group-item", "thread-item");
                threadItem.textContent = `Thread: ${thread.id}`;
                threadItem.onclick = () => {
                    threadId = thread.id;
                    loadMessages();
                };
                threadsList.appendChild(threadItem);
            });
        }

        async function loadMessages() {
            if (!threadId) return;
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = "";

            const response = await fetch(`http://127.0.0.1:8000/messages/${threadId}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                alert("Error loading messages");
                return;
            }
            
            const result = await response.json();
            result.messages.forEach(msg => {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("alert", msg.role === "assistant" ? "alert-primary" : "alert-secondary", "mt-2");
                messageDiv.textContent = `${msg.role === "assistant" ? "Assistant" : "You"}: ${msg.content}`;
                chatBox.appendChild(messageDiv);
            });
            
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            if (!threadId) {
                alert("Please select a thread first.");
                return;
            }
        
            const messageInput = document.getElementById('messageInput');
            const fileInput = document.getElementById('fileInput');
            const chatBox = document.getElementById('chatBox');
        
            const messageText = messageInput.value.trim();
            const file = fileInput.files[0];
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –≤–≤–µ–¥–µ–Ω–æ, –µ—Å–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —Ñ–∞–π–ª
            if (file && !messageText) {
                alert("Please enter a message along with the file.");
                return;
            }
        
            const formData = new FormData();
            formData.append("query", messageText);
            if (file) {
                formData.append("file", file);
            }
        
            const response = await fetch(`http://127.0.0.1:8000/chat/${threadId}`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: formData
            });
        
            if (!response.ok) {
                alert("Error: Unauthorized or Bad Request");
                return;
            }
        
            const result = await response.json();
        
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (messageText) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("alert", "alert-secondary", "mt-2");
                messageDiv.textContent = `You: ${messageText}`;
                chatBox.appendChild(messageDiv);
            }
        
            // –ï—Å–ª–∏ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (file) {
                const fileDiv = document.createElement("div");
                fileDiv.classList.add("alert", "alert-info", "mt-2");
                fileDiv.textContent = `üìé Attached file: ${file.name}`;
                chatBox.appendChild(fileDiv);
            }
        
            // –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ç—Ä–µ–¥, –æ–±–Ω–æ–≤–ª—è–µ–º ID –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–¥–æ–≤
            if (result.new_thread_id) {
                threadId = result.new_thread_id;
                loadThreads();
            }
        
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            if (result.assistant_response) {
                const responseDiv = document.createElement("div");
                responseDiv.classList.add("alert", "alert-primary", "mt-2");
                responseDiv.textContent = `Assistant: ${result.assistant_response}`;
                chatBox.appendChild(responseDiv);
            }
        
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
            if (result.document_download_url) {
                const linkDiv = document.createElement("div");
                linkDiv.classList.add("alert", "alert-warning", "mt-2");
                linkDiv.innerHTML = `üìÑ <a href="${result.document_download_url}" target="_blank">Download Document</a>`;
                chatBox.appendChild(linkDiv);
            }
        
            chatBox.scrollTop = chatBox.scrollHeight;
            messageInput.value = "";
            fileInput.value = ""; // –û—á–∏—â–∞–µ–º input file –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        }
        
        

        window.onload = () => {
            loadThreads();
        };
    </script>
</body>
</html>
